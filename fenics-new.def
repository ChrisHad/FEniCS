BootStrap: debootstrap
OSVersion: xenial
MirrorURL: http://mirror.bytemark.co.uk/ubuntu/
Include: bash

%environment

export FENICS_HOME=/usr/local/fenics
export FENICS_PREFIX=$FENICS_HOME
export FENICS_PYTHON_MAJOR_VERSION=3
export FENICS_PYTHON_MINOR_VERSION=5
export LC_ALL=C
export MPI4PY_VERSION=2.0.0 
export OPENBLAS_NUM_THREADS=1 
export OPENBLAS_VERBOSE=0
export PETSC_DIR=/usr/local/petsc-64
export PETSC_VERSION=3.7.6
export PETSC4PY_VERSION=3.7.0 
export SLEPC_DIR=/usr/local/slepc-64
export SLEPC_VERSION=3.7.3
export SLEPC4PY_VERSION=3.7.0 
export SWIG_VERSION=3.0.10 
export TRILINOS_VERSION=12.10.1 

export PATH=$FENICS_HOME/bin:$HOME/bin:$PATH
export LD_LIBRARY_PATH=$FENICS_HOME/lib:$LD_LIBRARY_PATH
export PKG_CONFIG_PATH=$FENICS_HOME/lib/pkgconfig:$PKG_CONFIG_PATH
export PYTHONPATH=$FENICS_HOME/lib/python${FENICS_PYTHON_MAJOR_VERSION}.${FENICS_PYTHON_MINOR_VERSION}/site-packages:$PYTHONPATH
export MANPATH=$FENICS_HOME/share/man:$MANPATH
export SRC_DIR=$FENICS_HOME/src
export PYTHON=/usr/bin/python${FENICS_PYTHON_MAJOR_VERSION}

%post

export FENICS_HOME=/usr/local/fenics
export FENICS_PREFIX=$FENICS_HOME
export FENICS_PYTHON_MAJOR_VERSION=3
export FENICS_PYTHON_MINOR_VERSION=5
export PETSC_DIR=/usr/local/petsc-64
export PETSC_VERSION=3.7.6
export SLEPC_DIR=/usr/local/slepc-64
export SLEPC_VERSION=3.7.3
export SWIG_VERSION=3.0.10
export PETSC4PY_VERSION=3.7.0
export SLEPC4PY_VERSION=3.7.0
export SRC_DIR=$FENICS_HOME/src
export NUMPROCS=$(cat /proc/cpuinfo|grep ^processor|wc -l)
export PYTHON=/usr/bin/python${FENICS_PYTHON_MAJOR_VERSION}
export MPI4PY_VERSION=2.0.0

. /.singularity.d/env/90-environment.sh

if [ ! -d "$FENICS_HOME" ]
then
    mkdir -p $FENICS_HOME
fi

if [ ! -d "${FENICS_HOME}/src" ]
then
    mkdir -p $FENICS_HOME/src
fi

if [ ! -d "${FENICS_HOME}/lib/python${FENICS_PYTHON_MAJOR_VERSION}.${FENICS_PYTHON_MINOR_VERSION}/site-packages" ]
then
    mkdir -p ${FENICS_HOME}/lib/python${FENICS_PYTHON_MAJOR_VERSION}.${FENICS_PYTHON_MINOR_VERSION}/site-packages
fi

apt-get -qq update
apt-get -y install python3-software-properties \
        software-properties-common \
        wget 

add-apt-repository universe 
apt-get -qq update

apt-get -y install python3-dev \
        python3-flufl.lock \
        python3-matplotlib \
        python3-numpy \
        python3-ply \
        python3-pytest \
        python3-scipy \
        python3-six \
        python3-urllib3 \
	python3-pip \
        mpich \
	libmpich-dev \
	bison \
	flex \
	libopenblas-base \
	libopenblas-dev \
	liblapack-dev \
	libpcre3-dev \
	libpcre3 \
	git \
	libeigen3-dev \
	libboost-dev \
	libboost-all-dev \
	libgmp-dev \
	libmpfr-dev \
	cmake \
	libmlx4-1 \
	libmlx5-1 \
	libdapl2 \
	vim
apt-get clean

pip3 install --upgrade pip
pip3 install setuptools && \
rm -rf /tmp/*

if [ ! -d "$PETSC_DIR" ]
then
    mkdir -p $PETSC_DIR
fi
cd /tmp
wget --quiet -nc http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-lite-${PETSC_VERSION}.tar.gz && \
tar -xf petsc-lite-${PETSC_VERSION}.tar.gz && \
cd petsc-${PETSC_VERSION} && \
PETSC_DIR=$PWD ./configure --COPTFLAGS="-O2" \
            --CXXOPTFLAGS="-O2" \
            --FOPTFLAGS="-O2" \
            --with-blas-lib=/usr/lib/libopenblas.a \
	    --with-lapack-lib=/usr/lib/liblapack.a \
            --with-c-support \
            --with-debugging=0 \
            --with-shared-libraries \
	    --enable-parallel=1 \
            --download-suitesparse \
            --download-metis \
            --download-parmetis \
            --download-ptscotch \
            --download-hypre \
            --download-superlu_dist \
	    --download-hdf5 \
            --prefix=/usr/local/petsc-64 && \
make && \
make install && \
cd .. && rm -rf petsc*

if [ ! -d "$SLEPC_DIR" ]
then
    mkdir -p $SLEPC_DIR
fi

#Install SLEPc from source
wget -nc --quiet https://bitbucket.org/slepc/slepc/get/v${SLEPC_VERSION}.tar.gz -O slepc-${SLEPC_VERSION}.tar.gz && \
mkdir -p slepc-src && tar -xf slepc-${SLEPC_VERSION}.tar.gz -C slepc-src --strip-components 1 && \
export PETSC_DIR=/usr/local/petsc-64 && \
cd slepc-src && \
SLEPC_DIR=$PWD ./configure --prefix=/usr/local/slepc-64 && \
make && \
make install  
cd .. && rm -rf slepc*

# Install Jupyter, sympy, mpi4py, petsc4py and slepc4py
#  and swig from source
export PETSC_DIR=/usr/local/petsc-64
export SLEPC_DIR=$SLEPC_DIR
pip3 install jupyter && \
pip3 install sympy && \
pip3 install https://bitbucket.org/mpi4py/mpi4py/downloads/mpi4py-${MPI4PY_VERSION}.tar.gz && \
pip3 install https://bitbucket.org/petsc/petsc4py/downloads/petsc4py-${PETSC4PY_VERSION}.tar.gz && \
pip3 install https://bitbucket.org/slepc/slepc4py/downloads/slepc4py-${SLEPC4PY_VERSION}.tar.gz && \
wget -nc --quiet http://downloads.sourceforge.net/swig/swig-${SWIG_VERSION}.tar.gz && \
tar xf swig-${SWIG_VERSION}.tar.gz && \
cd swig-${SWIG_VERSION} && \
./configure && \
make && \
make install
cd .. && rm -rf swig*

mkdir -p $FENICS_HOME/bin
#   This should be changed at some point
git clone https://github.com/ChrisHad/FEniCS.git 
cp FEniCS/fenics* $FENICS_HOME/bin
chmod +x $FENICS_HOME/bin/fenics-ctl
echo $FENICS_HOME
. $FENICS_HOME/bin/fenics.env.conf
$FENICS_HOME/bin/fenics-ctl update

%runscript

exec /usr/bin/python3

%test

. /environment
python $FENICS_HOME/share/dolfin/demo/documented/poisson/python/demo_poisson.py
